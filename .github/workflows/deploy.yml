# deploy.yml
name: ðŸš€ Deploy AutomÃ¡tico para EC2

on:
  push:
    branches: [ "main", "feature/infraestrutura" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ”» Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ“¤ Enviar arquivos para a EC2
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ubuntu  # âœ… Alterado de ec2-user para ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "."
          target: "/home/ubuntu/app"  # âœ… DiretÃ³rio do usuÃ¡rio ubuntu
          rm: true

      - name: ðŸ› ï¸ Criar .env na EC2
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ubuntu  # âœ…
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/ubuntu/app
            cat > .env << EOF
            DB_HOST=${{ secrets.DB_HOST }}
            DB_PORT=5432
            DB_USER=${{ secrets.DB_USER }}
            DB_PASS=${{ secrets.DB_PASS }}
            DB_NAME=${{ secrets.DB_NAME }}
            ASAAS_API_URL=${{ secrets.ASAAS_API_URL }}
            ASAAS_API_KEY=${{ secrets.ASAAS_API_KEY }}
            ASAAS_CONECTAR_WALLET_ID=${{ secrets.ASAAS_CONECTAR_WALLET_ID }}
            VALOR_MULTA=${{ secrets.VALOR_MULTA }}
            VALOR_JUROS=${{ secrets.VALOR_JUROS }}
            PERCENTUAL_SPLIT=${{ secrets.PERCENTUAL_SPLIT }}
            NODE_ENV=production
            EOF
            echo "âœ… .env criado com DB_HOST=${{ secrets.DB_HOST }}"
            cat .env

      - name: ðŸ³ Deploy com Docker Compose
        uses: appleboy/ssh-action@v0.1.10
        with:
          username: ubuntu
          target: /home/ubuntu/app-prod  # ou /home/ubuntu/app-dev
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/ubuntu/app
            echo "ðŸ›‘ Parando container antigo..."
            docker-compose down || true
            echo "ðŸ› ï¸  Construindo e subindo API..."
            docker-compose up -d --build
            echo "ðŸ“‹ Logs do container:"
            docker logs api-pagamentos

      - name: ðŸŒ Testar conectividade com o RDS
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ubuntu  # âœ…
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "ðŸ” Testando conexÃ£o com o RDS..."
            sudo apt update && sudo apt install -y ncdu --assume-yes
            nc -zv ${{ secrets.DB_HOST }} 5432 || echo "âš ï¸ Falha na conexÃ£o com o banco"