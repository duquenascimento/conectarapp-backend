name: ğŸš€ Deploy AutomÃ¡tico para EC2

on:
  push:
    branches: [ "develop", "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”» Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¤ Enviar arquivos para a EC2 (DEV)
        if: github.ref == 'refs/heads/develop'
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "."
          target: "/home/ubuntu/app-dev"
          rm: true

      - name: ğŸ“¤ Enviar arquivos para a EC2 (PROD)
        if: github.ref == 'refs/heads/main'
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "."
          target: "/home/ubuntu/app-prod"
          rm: true

      - name: ğŸ› ï¸ Criar .env na EC2 (DEV)
        if: github.ref == 'refs/heads/develop'
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/ubuntu/app-dev
            echo "ğŸ”§ Criando .env para DEV..."

            # FunÃ§Ã£o para escrever certificados com quebras de linha
            write_cert() {
              echo "$1" | sed 's/\\n/\n/g'
            }

            # Cria o .env do zero
            > .env

            # VariÃ¡veis simples
            echo "DATABASE_URL=${{ secrets.DATABASE_URL_DEV }}" >> .env
            echo "HOST=localhost" >> .env
            echo "PORT=9841" >> .env
            echo "LOG_PATH=../log.txt" >> .env
            echo "SALT=12" >> .env
            echo "INTERNAL_ERROR_MSG=internal error, try later." >> .env

            # IntegraÃ§Ãµes
            echo "API_DB_CONECTAR=${{ secrets.API_DB_CONECTAR }}" >> .env
            echo "API_MOTOR_COTACAO=${{ secrets.API_MOTOR_COTACAO }}" >> .env
            echo "URL_API_ANTIGA=${{ secrets.URL_API_ANTIGA }}" >> .env
            echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> .env
            echo "EXTERNAL_ID=${{ secrets.EXTERNAL_ID }}" >> .env
            echo "USERNAME=${{ secrets.USERNAME }}" >> .env
            echo "SYSTEM_USER_PASS=${{ secrets.SYSTEM_USER_PASS }}" >> .env
            echo "AUTH_TOKEN=${{ secrets.AUTH_TOKEN }}" >> .env

            # ChatGuru
            echo "CG_API_KEY=${{ secrets.CG_API_KEY }}" >> .env
            echo "CG_ACCOUNT_ID=${{ secrets.CG_ACCOUNT_ID }}" >> .env
            echo "CG_PHONE_ID=${{ secrets.CG_PHONE_ID }}" >> .env

            # CPFCNPJ
            echo "API_TOKEN_CPFCNPJ=${{ secrets.API_TOKEN_CPFCNPJ }}" >> .env
            echo "API_URL_CPFCNPJ=${{ secrets.API_URL_CPFCNPJ }}" >> .env

            # JWT
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env

            # Documentos
            echo "DOCUMINT_KEY=${{ secrets.DOCUMINT_KEY }}" >> .env

            # Email
            echo "SENDGRID_KEY=${{ secrets.SENDGRID_KEY }}" >> .env
            echo "SENDGRID_TEMPLATE_PASSWORD_RECOVERY=${{ secrets.SENDGRID_TEMPLATE_PASSWORD_RECOVERY }}" >> .env

            # OAuth
            echo "CLIENT_ID=${{ secrets.CLIENT_ID }}" >> .env
            echo "CLIENT_SECRET=${{ secrets.CLIENT_SECRET }}" >> .env
            echo "GRANT_TYPE=${{ secrets.GRANT_TYPE }}" >> .env
            echo "SCOPE=${{ secrets.SCOPE }}" >> .env
            echo "ACCOUNT_NUMBER=${{ secrets.ACCOUNT_NUMBER }}" >> .env

            # Pix ItaÃº
            echo "ITAU_PIX_KEY=${{ secrets.ITAU_PIX_KEY }}" >> .env
            echo "ITAU_CLIENT_ID=${{ secrets.ITAU_CLIENT_ID }}" >> .env
            echo "ITAU_AGENCY_ID=${{ secrets.ITAU_AGENCY_ID }}" >> .env
            echo "ITAU_ACCOUNT_ID=${{ secrets.ITAU_ACCOUNT_ID }}" >> .env
            echo "ITAU_TOKEN=${{ secrets.ITAU_TOKEN }}" >> .env
            echo "ITAU_SECRET=${{ secrets.ITAU_SECRET }}" >> .env
            echo "ITAU_ETAPA=${{ secrets.ITAU_ETAPA }}" >> .env

            # AWS S3
            echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}" >> .env
            echo "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}" >> .env
            echo "AWS_REGION=${{ secrets.AWS_REGION }}" >> .env
            echo "BUCKET_NAME=${{ secrets.BUCKET_NAME }}" >> .env

            # Airtable
            echo "AIRTABLE_TOKEN=${{ secrets.AIRTABLE_TOKEN }}" >> .env
            echo "AIRTABLE_BASE_ORDER_ID=${{ secrets.AIRTABLE_BASE_ORDER_ID }}" >> .env
            echo "AIRTABLE_BASE_ORDERTEXT_ID=${{ secrets.AIRTABLE_BASE_ORDERTEXT_ID }}" >> .env
            echo "AIRTABLE_BASE_SUPPLIERAPP_ID=${{ secrets.AIRTABLE_BASE_SUPPLIERAPP_ID }}" >> .env
            echo "AIRTABLE_BASE_REGISTER_ID=${{ secrets.AIRTABLE_BASE_REGISTER_ID }}" >> .env
            echo "AIRTABLE_TABLE_ORDERTEXT_NAME=${{ secrets.AIRTABLE_TABLE_ORDERTEXT_NAME }}" >> .env
            echo "AIRTABLE_TABLE_ORDERSUPPLIERAPP_NAME=${{ secrets.AIRTABLE_TABLE_ORDERSUPPLIERAPP_NAME }}" >> .env
            echo "AIRTABLE_TABLE_RESTSUPPLIERAPP_NAME=${{ secrets.AIRTABLE_TABLE_RESTSUPPLIERAPP_NAME }}" >> .env
            echo "AIRTABLE_TABLE_SUPPLIERSUPPLIERAPP_NAME=${{ secrets.AIRTABLE_TABLE_SUPPLIERSUPPLIERAPP_NAME }}" >> .env
            echo "AIRTABLE_TABLE_REGISTER_NAME=${{ secrets.AIRTABLE_TABLE_REGISTER_NAME }}" >> .env
            echo "AIRTABLE_TABLE_ORDER_NAME=${{ secrets.AIRTABLE_TABLE_ORDER_NAME }}" >> .env
            echo "AIRTABLE_TABLE_DETAILING_NAME=${{ secrets.AIRTABLE_TABLE_DETAILING_NAME }}" >> .env
            echo "AIRTABLE_TABLE_SUPPLIER_NAME=${{ secrets.AIRTABLE_TABLE_SUPPLIER_NAME }}" >> .env
            echo "AIRTABLE_TABLE_REST_NAME=${{ secrets.AIRTABLE_TABLE_REST_NAME }}" >> .env
            echo "AIRTABLE_TABLE_PRODUCT_NAME=${{ secrets.AIRTABLE_TABLE_PRODUCT_NAME }}" >> .env
            echo "AIRTABLE_BASE_DBCLIENTE_ID=${{ secrets.AIRTABLE_BASE_DBCLIENTE_ID }}" >> .env
            echo "AIRTABLE_TABLE_DBCLIENTE_NAME=${{ secrets.AIRTABLE_TABLE_DBCLIENTE_NAME }}" >> .env
            echo "AIRTABLE_TABLE_DB_USUARIOS_REST=${{ secrets.AIRTABLE_TABLE_DB_USUARIOS_REST }}" >> .env

            # Inter
            echo "INTER_CLIENT_ID=${{ secrets.INTER_CLIENT_ID }}" >> .env
            echo "INTER_CLIENT_SECRET=${{ secrets.INTER_CLIENT_SECRET }}" >> .env
            echo "INTER_GRANT_TYPE=${{ secrets.INTER_GRANT_TYPE }}" >> .env
            echo "INTER_SCOPE=${{ secrets.INTER_SCOPE }}" >> .env
            echo "INTER_ACCOUNT_NUMBER=${{ secrets.INTER_ACCOUNT_NUMBER }}" >> .env
            echo "INTER_PIX_KEY=${{ secrets.INTER_PIX_KEY }}" >> .env
            echo "INTER_HOST=${{ secrets.INTER_HOST }}" >> .env
            echo "INTER_PATH_AUTH=${{ secrets.INTER_PATH_AUTH }}" >> .env
            echo "INTER_PATH_GENERATE_BOLECODE=${{ secrets.INTER_PATH_GENERATE_BOLECODE }}" >> .env
            echo "INTER_PATH_GENERATE_SIMPLE_PIX=${{ secrets.INTER_PATH_GENERATE_SIMPLE_PIX }}" >> .env
            echo "INTER_PATH_GENERATE_FINE_AND_INTEREST_PIX=${{ secrets.INTER_PATH_GENERATE_FINE_AND_INTEREST_PIX }}" >> .env
            echo "INTER_PATH_WEBHOOK=${{ secrets.INTER_PATH_WEBHOOK }}" >> .env
            echo "INTER_PIX_TIMEOUT=${{ secrets.INTER_PIX_TIMEOUT }}" >> .env
            echo "SECONDS_TO_REJECT_BOLECODE_PROMISE=${{ secrets.SECONDS_TO_REJECT_BOLECODE_PROMISE }}" >> .env
            echo "BANK_CLIENT=${{ secrets.BANK_CLIENT }}" >> .env

            # Slack
            echo "SLACK_TOKEN=${{ secrets.SLACK_TOKEN }}" >> .env
            echo "SLACK_BUGS_AND_ERROS_CHANNELID=${{ secrets.SLACK_BUGS_AND_ERROS_CHANNELID }}" >> .env

            # Outros
            echo "MINUTES_TO_CANCEL_ORDER=${{ secrets.MINUTES_TO_CANCEL_ORDER }}" >> .env
            echo "MASTER_PASSWORD_HASH=${{ secrets.MASTER_PASSWORD_HASH }}" >> .env

            # Certificados (com funÃ§Ã£o write_cert)
            # echo "CERT=" >> .env
            # write_cert "${{ secrets.CERT }}" >> .env

            # echo "KEY=" >> .env
            # write_cert "${{ secrets.KEY }}" >> .env

            # echo "ITAU_CRT=" >> .env
            # write_cert "${{ secrets.ITAU_CRT }}" >> .env

            # echo "ITAU_KEY=" >> .env
            # write_cert "${{ secrets.ITAU_KEY }}" >> .env

            # echo "INTER_CERT=" >> .env
            # write_cert "${{ secrets.INTER_CERT }}" >> .env

            # echo "INTER_KEY=" >> .env
            # write_cert "${{ secrets.INTER_KEY }}" >> .env

            echo "NODE_ENV=development" >> .env

            echo "âœ… .env DEV criado com sucesso"
            echo "ğŸ³ Subindo container DEV..."
            docker-compose -f docker-compose.dev.yml down || true
            docker-compose -f docker-compose.dev.yml up -d --build
            echo "ğŸ“‹ Logs do container DEV:"
            docker logs api-dev

      - name: ğŸ› ï¸ Criar .env na EC2 (PROD)
        if: github.ref == 'refs/heads/main'
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/ubuntu/app-prod
            echo "ğŸ”§ Criando .env para PROD..."

            write_cert() {
              echo "$1" | sed 's/\\n/\n/g'
            }

            > .env

            # (Repita todas as variÃ¡veis, mudando apenas DATABASE_URL_PROD e NODE_ENV=production)
            echo "DATABASE_URL=${{ secrets.DATABASE_URL_PROD }}" >> .env
            # ... (todas as outras variÃ¡veis iguais)
            echo "NODE_ENV=production" >> .env

            # echo "CERT=" >> .env
            # write_cert "${{ secrets.CERT }}" >> .env

            # echo "KEY=" >> .env
            # write_cert "${{ secrets.KEY }}" >> .env

            # echo "ITAU_CRT=" >> .env
            # write_cert "${{ secrets.ITAU_CRT }}" >> .env

            # echo "ITAU_KEY=" >> .env
            # write_cert "${{ secrets.ITAU_KEY }}" >> .env

            # echo "INTER_CERT=" >> .env
            # write_cert "${{ secrets.INTER_CERT }}" >> .env

            # echo "INTER_KEY=" >> .env
            # write_cert "${{ secrets.INTER_KEY }}" >> .env

            echo "âœ… .env PROD criado com sucesso"
            echo "ğŸ³ Subindo container PROD..."
            docker-compose -f docker-compose.prod.yml down || true
            docker-compose -f docker-compose.prod.yml up -d --build
            echo "ğŸ“‹ Logs do container PROD:"
            docker logs api-prod