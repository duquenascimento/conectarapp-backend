name: ğŸš€ Deploy AutomÃ¡tico para EC2

on:
  push:
    branches: [ "develop", "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”» Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¤ Enviar arquivos para a EC2 (DEV)
        if: github.ref == 'refs/heads/develop'
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "."
          target: "/home/ubuntu/app-dev"
          rm: true

      - name: ğŸ“¤ Enviar arquivos para a EC2 (PROD)
        if: github.ref == 'refs/heads/main'
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "."
          target: "/home/ubuntu/app-prod"
          rm: true

      - name: ğŸ› ï¸ Criar .env na EC2 (DEV)
        if: github.ref == 'refs/heads/develop'
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/ubuntu/app-dev
            echo "ğŸ”§ Criando .env para DEV..."

            # FunÃ§Ã£o para converter \n para quebra de linha real
            write_cert() {
              printf '%b' "$1"
            }

            # Cria o .env do zero
            > .env

            # === Banco de dados ===
            echo "DATABASE_URL=${{ secrets.DATABASE_URL_DEV }}" >> .env
            echo "HOST=localhost" >> .env
            echo "PORT=9841" >> .env
            echo "LOG_PATH=../log.txt" >> .env
            echo "SALT=12" >> .env
            echo "INTERNAL_ERROR_MSG=internal error, try later." >> .env

            # === IntegraÃ§Ãµes ===
            echo "API_DB_CONECTAR=${{ secrets.API_DB_CONECTAR }}" >> .env
            echo "API_MOTOR_COTACAO=${{ secrets.API_MOTOR_COTACAO }}" >> .env
            echo "URL_API_ANTIGA=${{ secrets.URL_API_ANTIGA }}" >> .env
            echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> .env
            echo "EXTERNAL_ID=${{ secrets.EXTERNAL_ID }}" >> .env
            echo "USERNAME=${{ secrets.USERNAME }}" >> .env
            echo "SYSTEM_USER_PASS=${{ secrets.SYSTEM_USER_PASS }}" >> .env
            echo "AUTH_TOKEN=${{ secrets.AUTH_TOKEN }}" >> .env

            # === ChatGuru ===
            echo "CG_API_KEY=${{ secrets.CG_API_KEY }}" >> .env
            echo "CG_ACCOUNT_ID=${{ secrets.CG_ACCOUNT_ID }}" >> .env
            echo "CG_PHONE_ID=${{ secrets.CG_PHONE_ID }}" >> .env

            # === CPFCNPJ ===
            echo "API_TOKEN_CPFCNPJ=${{ secrets.API_TOKEN_CPFCNPJ }}" >> .env
            echo "API_URL_CPFCNPJ=${{ secrets.API_URL_CPFCNPJ }}" >> .env

            # === JWT ===
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env

            # === Documentos ===
            echo "DOCUMINT_KEY=${{ secrets.DOCUMINT_KEY }}" >> .env

            # === Email ===
            echo "SENDGRID_KEY=${{ secrets.SENDGRID_KEY }}" >> .env
            echo "SENDGRID_TEMPLATE_PASSWORD_RECOVERY=${{ secrets.SENDGRID_TEMPLATE_PASSWORD_RECOVERY }}" >> .env

            # === OAuth ===
            echo "CLIENT_ID=${{ secrets.CLIENT_ID }}" >> .env
            echo "CLIENT_SECRET=${{ secrets.CLIENT_SECRET }}" >> .env
            echo "GRANT_TYPE=${{ secrets.GRANT_TYPE }}" >> .env
            echo "SCOPE=${{ secrets.SCOPE }}" >> .env
            echo "ACCOUNT_NUMBER=${{ secrets.ACCOUNT_NUMBER }}" >> .env

            # === AWS S3 ===
            echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}" >> .env
            echo "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}" >> .env
            echo "AWS_REGION=${{ secrets.AWS_REGION }}" >> .env
            echo "BUCKET_NAME=${{ secrets.BUCKET_NAME }}" >> .env

            # === Airtable ===
            echo "AIRTABLE_TOKEN=${{ secrets.AIRTABLE_TOKEN }}" >> .env
            echo "AIRTABLE_BASE_ORDER_ID=${{ secrets.AIRTABLE_BASE_ORDER_ID }}" >> .env
            echo "AIRTABLE_BASE_ORDERTEXT_ID=${{ secrets.AIRTABLE_BASE_ORDERTEXT_ID }}" >> .env
            echo "AIRTABLE_BASE_SUPPLIERAPP_ID=${{ secrets.AIRTABLE_BASE_SUPPLIERAPP_ID }}" >> .env
            echo "AIRTABLE_BASE_REGISTER_ID=${{ secrets.AIRTABLE_BASE_REGISTER_ID }}" >> .env
            echo "AIRTABLE_TABLE_ORDERTEXT_NAME=${{ secrets.AIRTABLE_TABLE_ORDERTEXT_NAME }}" >> .env
            echo "AIRTABLE_TABLE_ORDERSUPPLIERAPP_NAME=${{ secrets.AIRTABLE_TABLE_ORDERSUPPLIERAPP_NAME }}" >> .env
            echo "AIRTABLE_TABLE_RESTSUPPLIERAPP_NAME=${{ secrets.AIRTABLE_TABLE_RESTSUPPLIERAPP_NAME }}" >> .env
            echo "AIRTABLE_TABLE_SUPPLIERSUPPLIERAPP_NAME=${{ secrets.AIRTABLE_TABLE_SUPPLIERSUPPLIERAPP_NAME }}" >> .env
            echo "AIRTABLE_TABLE_REGISTER_NAME=${{ secrets.AIRTABLE_TABLE_REGISTER_NAME }}" >> .env
            echo "AIRTABLE_TABLE_ORDER_NAME=${{ secrets.AIRTABLE_TABLE_ORDER_NAME }}" >> .env
            echo "AIRTABLE_TABLE_DETAILING_NAME=${{ secrets.AIRTABLE_TABLE_DETAILING_NAME }}" >> .env
            echo "AIRTABLE_TABLE_SUPPLIER_NAME=${{ secrets.AIRTABLE_TABLE_SUPPLIER_NAME }}" >> .env
            echo "AIRTABLE_TABLE_REST_NAME=${{ secrets.AIRTABLE_TABLE_REST_NAME }}" >> .env
            echo "AIRTABLE_TABLE_PRODUCT_NAME=${{ secrets.AIRTABLE_TABLE_PRODUCT_NAME }}" >> .env
            echo "AIRTABLE_BASE_DBCLIENTE_ID=${{ secrets.AIRTABLE_BASE_DBCLIENTE_ID }}" >> .env
            echo "AIRTABLE_TABLE_DBCLIENTE_NAME=${{ secrets.AIRTABLE_TABLE_DBCLIENTE_NAME }}" >> .env
            echo "AIRTABLE_TABLE_DB_USUARIOS_REST=${{ secrets.AIRTABLE_TABLE_DB_USUARIOS_REST }}" >> .env

            # === Slack ===
            echo "SLACK_TOKEN=${{ secrets.SLACK_TOKEN }}" >> .env
            echo "SLACK_BUGS_AND_ERROS_CHANNELID=${{ secrets.SLACK_BUGS_AND_ERROS_CHANNELID }}" >> .env

            # === Outros ===
            echo "MINUTES_TO_CANCEL_ORDER=${{ secrets.MINUTES_TO_CANCEL_ORDER }}" >> .env
            echo "MASTER_PASSWORD_HASH=${{ secrets.MASTER_PASSWORD_HASH }}" >> .env

            # === Certificados (reconstruÃ­dos com \n â†’ quebra de linha) ===
            echo "CERT=" >> .env
            write_cert "${{ secrets.CERT }}" >> .env

            echo "KEY=" >> .env
            write_cert "${{ secrets.KEY }}" >> .env

            # === Ambiente ===
            echo "NODE_ENV=development" >> .env

            echo "âœ… .env DEV criado com sucesso"
            echo "ğŸ³ Subindo container DEV..."
            docker-compose -f docker-compose.dev.yml down || true
            docker-compose -f docker-compose.dev.yml up -d --build
            echo "ğŸ“‹ Logs do container DEV:"
            docker logs api-dev

      - name: ğŸ› ï¸ Criar .env na EC2 (PROD)
        if: github.ref == 'refs/heads/main'
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/ubuntu/app-prod
            echo "ğŸ”§ Criando .env para PROD..."

            write_cert() {
              printf '%b' "$1"
            }

            > .env

            # === Banco de dados ===
            echo "DATABASE_URL=${{ secrets.DATABASE_URL_PROD }}" >> .env
            echo "HOST=localhost" >> .env
            echo "PORT=9841" >> .env
            echo "LOG_PATH=../log.txt" >> .env
            echo "SALT=12" >> .env
            echo "INTERNAL_ERROR_MSG=internal error, try later." >> .env

            # === IntegraÃ§Ãµes ===
            echo "API_DB_CONECTAR=${{ secrets.API_DB_CONECTAR }}" >> .env
            echo "API_MOTOR_COTACAO=${{ secrets.API_MOTOR_COTACAO }}" >> .env
            echo "URL_API_ANTIGA=${{ secrets.URL_API_ANTIGA }}" >> .env
            echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> .env
            echo "EXTERNAL_ID=${{ secrets.EXTERNAL_ID }}" >> .env
            echo "USERNAME=${{ secrets.USERNAME }}" >> .env
            echo "SYSTEM_USER_PASS=${{ secrets.SYSTEM_USER_PASS }}" >> .env
            echo "AUTH_TOKEN=${{ secrets.AUTH_TOKEN }}" >> .env

            # === ChatGuru ===
            echo "CG_API_KEY=${{ secrets.CG_API_KEY }}" >> .env
            echo "CG_ACCOUNT_ID=${{ secrets.CG_ACCOUNT_ID }}" >> .env
            echo "CG_PHONE_ID=${{ secrets.CG_PHONE_ID }}" >> .env

            # === CPFCNPJ ===
            echo "API_TOKEN_CPFCNPJ=${{ secrets.API_TOKEN_CPFCNPJ }}" >> .env
            echo "API_URL_CPFCNPJ=${{ secrets.API_URL_CPFCNPJ }}" >> .env

            # === JWT ===
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env

            # === Documentos ===
            echo "DOCUMINT_KEY=${{ secrets.DOCUMINT_KEY }}" >> .env

            # === Email ===
            echo "SENDGRID_KEY=${{ secrets.SENDGRID_KEY }}" >> .env
            echo "SENDGRID_TEMPLATE_PASSWORD_RECOVERY=${{ secrets.SENDGRID_TEMPLATE_PASSWORD_RECOVERY }}" >> .env

            # === OAuth ===
            echo "CLIENT_ID=${{ secrets.CLIENT_ID }}" >> .env
            echo "CLIENT_SECRET=${{ secrets.CLIENT_SECRET }}" >> .env
            echo "GRANT_TYPE=${{ secrets.GRANT_TYPE }}" >> .env
            echo "SCOPE=${{ secrets.SCOPE }}" >> .env
            echo "ACCOUNT_NUMBER=${{ secrets.ACCOUNT_NUMBER }}" >> .env

            # === AWS S3 ===
            echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}" >> .env
            echo "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}" >> .env
            echo "AWS_REGION=${{ secrets.AWS_REGION }}" >> .env
            echo "BUCKET_NAME=${{ secrets.BUCKET_NAME }}" >> .env

            # === Airtable ===
            echo "AIRTABLE_TOKEN=${{ secrets.AIRTABLE_TOKEN }}" >> .env
            echo "AIRTABLE_BASE_ORDER_ID=${{ secrets.AIRTABLE_BASE_ORDER_ID }}" >> .env
            echo "AIRTABLE_BASE_ORDERTEXT_ID=${{ secrets.AIRTABLE_BASE_ORDERTEXT_ID }}" >> .env
            echo "AIRTABLE_BASE_SUPPLIERAPP_ID=${{ secrets.AIRTABLE_BASE_SUPPLIERAPP_ID }}" >> .env
            echo "AIRTABLE_BASE_REGISTER_ID=${{ secrets.AIRTABLE_BASE_REGISTER_ID }}" >> .env
            echo "AIRTABLE_TABLE_ORDERTEXT_NAME=${{ secrets.AIRTABLE_TABLE_ORDERTEXT_NAME }}" >> .env
            echo "AIRTABLE_TABLE_ORDERSUPPLIERAPP_NAME=${{ secrets.AIRTABLE_TABLE_ORDERSUPPLIERAPP_NAME }}" >> .env
            echo "AIRTABLE_TABLE_RESTSUPPLIERAPP_NAME=${{ secrets.AIRTABLE_TABLE_RESTSUPPLIERAPP_NAME }}" >> .env
            echo "AIRTABLE_TABLE_SUPPLIERSUPPLIERAPP_NAME=${{ secrets.AIRTABLE_TABLE_SUPPLIERSUPPLIERAPP_NAME }}" >> .env
            echo "AIRTABLE_TABLE_REGISTER_NAME=${{ secrets.AIRTABLE_TABLE_REGISTER_NAME }}" >> .env
            echo "AIRTABLE_TABLE_ORDER_NAME=${{ secrets.AIRTABLE_TABLE_ORDER_NAME }}" >> .env
            echo "AIRTABLE_TABLE_DETAILING_NAME=${{ secrets.AIRTABLE_TABLE_DETAILING_NAME }}" >> .env
            echo "AIRTABLE_TABLE_SUPPLIER_NAME=${{ secrets.AIRTABLE_TABLE_SUPPLIER_NAME }}" >> .env
            echo "AIRTABLE_TABLE_REST_NAME=${{ secrets.AIRTABLE_TABLE_REST_NAME }}" >> .env
            echo "AIRTABLE_TABLE_PRODUCT_NAME=${{ secrets.AIRTABLE_TABLE_PRODUCT_NAME }}" >> .env
            echo "AIRTABLE_BASE_DBCLIENTE_ID=${{ secrets.AIRTABLE_BASE_DBCLIENTE_ID }}" >> .env
            echo "AIRTABLE_TABLE_DBCLIENTE_NAME=${{ secrets.AIRTABLE_TABLE_DBCLIENTE_NAME }}" >> .env
            echo "AIRTABLE_TABLE_DB_USUARIOS_REST=${{ secrets.AIRTABLE_TABLE_DB_USUARIOS_REST }}" >> .env

            # === Slack ===
            echo "SLACK_TOKEN=${{ secrets.SLACK_TOKEN }}" >> .env
            echo "SLACK_BUGS_AND_ERROS_CHANNELID=${{ secrets.SLACK_BUGS_AND_ERROS_CHANNELID }}" >> .env

            # === Outros ===
            echo "MINUTES_TO_CANCEL_ORDER=${{ secrets.MINUTES_TO_CANCEL_ORDER }}" >> .env
            echo "MASTER_PASSWORD_HASH=${{ secrets.MASTER_PASSWORD_HASH }}" >> .env

            # === Certificados ===
            echo "CERT=" >> .env
            write_cert "${{ secrets.CERT }}" >> .env

            echo "KEY=" >> .env
            write_cert "${{ secrets.KEY }}" >> .env

            # === Ambiente ===
            echo "NODE_ENV=production" >> .env

            echo "âœ… .env PROD criado com sucesso"
            echo "ğŸ³ Subindo container PROD..."
            docker-compose -f docker-compose.prod.yml down || true
            docker-compose -f docker-compose.prod.yml up -d --build
            echo "ğŸ“‹ Logs do container PROD:"
            docker logs api-prod