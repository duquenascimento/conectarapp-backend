name: ðŸš€ Deploy AutomÃ¡tico para EC2

on:
  push:
    branches: [ "develop", "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ”» Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ“¤ Enviar arquivos para a EC2 (DEV)
        if: github.ref == 'refs/heads/develop'
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "."
          target: "/home/ubuntu/app-dev"
          rm: true

      - name: ðŸ“¤ Enviar arquivos para a EC2 (PROD)
        if: github.ref == 'refs/heads/main'
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "."
          target: "/home/ubuntu/app-prod"
          rm: true

      - name: ðŸ› ï¸ Criar .env na EC2 (DEV)
        if: github.ref == 'refs/heads/develop'
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/ubuntu/app-dev
            cat > .env.development << EOF
            # Banco de dados
            DATABASE_URL=${{ secrets.DEV_DATABASE_URL }}
            HOST=0.0.0.0
            PORT=3334
            LOG_PATH=../log.txt
            SALT=12
            INTERNAL_ERROR_MSG=internal error, try later.

            # IntegraÃ§Ãµes
            API_DB_CONECTAR=${{ secrets.DEV_API_DB_CONECTAR }}
            API_MOTOR_COTACAO=${{ secrets.DEV_API_MOTOR_COTACAO }}
            URL_API_ANTIGA=${{ secrets.DEV_URL_API_ANTIGA }}
            SECRET_KEY=${{ secrets.DEV_SECRET_KEY }}
            EXTERNAL_ID=${{ secrets.DEV_EXTERNAL_ID }}
            USERNAME=${{ secrets.DEV_USERNAME }}
            SYSTEM_USER_PASS=${{ secrets.DEV_SYSTEM_USER_PASS }}
            AUTH_TOKEN=${{ secrets.DEV_AUTH_TOKEN }}

            # ChatGuru
            CG_API_KEY=${{ secrets.DEV_CG_API_KEY }}
            CG_ACCOUNT_ID=${{ secrets.DEV_CG_ACCOUNT_ID }}
            CG_PHONE_ID=${{ secrets.DEV_CG_PHONE_ID }}

            # CPFCNPJ
            API_TOKEN_CPFCNPJ=${{ secrets.DEV_API_TOKEN_CPFCNPJ }}
            API_URL_CPFCNPJ=${{ secrets.DEV_API_URL_CPFCNPJ }}

            # JWT
            JWT_SECRET=${{ secrets.DEV_JWT_SECRET }}

            # Documentos
            DOCUMINT_KEY=${{ secrets.DEV_DOCUMINT_KEY }}

            # Email
            SENDGRID_KEY=${{ secrets.DEV_SENDGRID_KEY }}
            SENDGRID_TEMPLATE_PASSWORD_RECOVERY=${{ secrets.DEV_SENDGRID_TEMPLATE_PASSWORD_RECOVERY }}

            # OAuth
            CLIENT_ID=${{ secrets.DEV_CLIENT_ID }}
            CLIENT_SECRET=${{ secrets.DEV_CLIENT_SECRET }}
            GRANT_TYPE=${{ secrets.DEV_GRANT_TYPE }}
            SCOPE=${{ secrets.DEV_SCOPE }}
            ACCOUNT_NUMBER=${{ secrets.DEV_ACCOUNT_NUMBER }}

            # AWS S3
            AWS_ACCESS_KEY_ID=${{ secrets.DEV_AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY=${{ secrets.DEV_AWS_SECRET_ACCESS_KEY }}
            AWS_REGION=${{ secrets.DEV_AWS_REGION }}
            BUCKET_NAME=${{ secrets.DEV_BUCKET_NAME }}

            # Airtable
            AIRTABLE_TOKEN=${{ secrets.DEV_AIRTABLE_TOKEN }}
            AIRTABLE_BASE_ORDER_ID=${{ secrets.DEV_AIRTABLE_BASE_ORDER_ID }}
            AIRTABLE_BASE_ORDERTEXT_ID=${{ secrets.DEV_AIRTABLE_BASE_ORDERTEXT_ID }}
            AIRTABLE_BASE_SUPPLIERAPP_ID=${{ secrets.DEV_AIRTABLE_BASE_SUPPLIERAPP_ID }}
            AIRTABLE_BASE_REGISTER_ID=${{ secrets.DEV_AIRTABLE_BASE_REGISTER_ID }}
            AIRTABLE_TABLE_ORDERTEXT_NAME=${{ secrets.DEV_AIRTABLE_TABLE_ORDERTEXT_NAME }}
            AIRTABLE_TABLE_ORDERSUPPLIERAPP_NAME=${{ secrets.DEV_AIRTABLE_TABLE_ORDERSUPPLIERAPP_NAME }}
            AIRTABLE_TABLE_RESTSUPPLIERAPP_NAME=${{ secrets.DEV_AIRTABLE_TABLE_RESTSUPPLIERAPP_NAME }}
            AIRTABLE_TABLE_SUPPLIERSUPPLIERAPP_NAME=${{ secrets.DEV_AIRTABLE_TABLE_SUPPLIERSUPPLIERAPP_NAME }}
            AIRTABLE_TABLE_REGISTER_NAME=${{ secrets.DEV_AIRTABLE_TABLE_REGISTER_NAME }}
            AIRTABLE_TABLE_ORDER_NAME=${{ secrets.DEV_AIRTABLE_TABLE_ORDER_NAME }}
            AIRTABLE_TABLE_DETAILING_NAME=${{ secrets.DEV_AIRTABLE_TABLE_DETAILING_NAME }}
            AIRTABLE_TABLE_SUPPLIER_NAME=${{ secrets.DEV_AIRTABLE_TABLE_SUPPLIER_NAME }}
            AIRTABLE_TABLE_REST_NAME=${{ secrets.DEV_AIRTABLE_TABLE_REST_NAME }}
            AIRTABLE_TABLE_PRODUCT_NAME=${{ secrets.DEV_AIRTABLE_TABLE_PRODUCT_NAME }}
            AIRTABLE_BASE_DBCLIENTE_ID=${{ secrets.DEV_AIRTABLE_BASE_DBCLIENTE_ID }}
            AIRTABLE_TABLE_DBCLIENTE_NAME=${{ secrets.DEV_AIRTABLE_TABLE_DBCLIENTE_NAME }}
            AIRTABLE_TABLE_DB_USUARIOS_REST=${{ secrets.DEV_AIRTABLE_TABLE_DB_USUARIOS_REST }}

            # Slack
            SLACK_TOKEN=${{ secrets.DEV_SLACK_TOKEN }}
            SLACK_BUGS_AND_ERROS_CHANNELID=${{ secrets.DEV_SLACK_BUGS_AND_ERROS_CHANNELID }}

            # Outros
            MINUTES_TO_CANCEL_ORDER=${{ secrets.DEV_MINUTES_TO_CANCEL_ORDER }}
            MASTER_PASSWORD_HASH=${{ secrets.DEV_MASTER_PASSWORD_HASH }}

            # Ambiente
            NODE_ENV=development
            EOF
            echo "âœ… .env.development DEV criado com sucesso"
            cat .env.development

      - name: ðŸ› ï¸ Criar .env na EC2 (PROD)
        if: github.ref == 'refs/heads/main'
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/ubuntu/app-prod
            cat > .env << EOF
            # Banco de dados
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            HOST=0.0.0.0
            PORT=3333
            LOG_PATH=../log.txt
            SALT=12
            INTERNAL_ERROR_MSG=internal error, try later.

            # IntegraÃ§Ãµes
            API_DB_CONECTAR=${{ secrets.API_DB_CONECTAR }}
            API_MOTOR_COTACAO=${{ secrets.API_MOTOR_COTACAO }}
            URL_API_ANTIGA=${{ secrets.URL_API_ANTIGA }}
            SECRET_KEY=${{ secrets.SECRET_KEY }}
            EXTERNAL_ID=${{ secrets.EXTERNAL_ID }}
            USERNAME=${{ secrets.USERNAME }}
            SYSTEM_USER_PASS=${{ secrets.SYSTEM_USER_PASS }}
            AUTH_TOKEN=${{ secrets.AUTH_TOKEN }}

            # ChatGuru
            CG_API_KEY=${{ secrets.CG_API_KEY }}
            CG_ACCOUNT_ID=${{ secrets.CG_ACCOUNT_ID }}
            CG_PHONE_ID=${{ secrets.CG_PHONE_ID }}

            # CPFCNPJ
            API_TOKEN_CPFCNPJ=${{ secrets.API_TOKEN_CPFCNPJ }}
            API_URL_CPFCNPJ=${{ secrets.API_URL_CPFCNPJ }}

            # JWT
            JWT_SECRET=${{ secrets.JWT_SECRET }}

            # Documentos
            DOCUMINT_KEY=${{ secrets.DOCUMINT_KEY }}

            # Email
            SENDGRID_KEY=${{ secrets.SENDGRID_KEY }}
            SENDGRID_TEMPLATE_PASSWORD_RECOVERY=${{ secrets.SENDGRID_TEMPLATE_PASSWORD_RECOVERY }}

            # OAuth
            CLIENT_ID=${{ secrets.CLIENT_ID }}
            CLIENT_SECRET=${{ secrets.CLIENT_SECRET }}
            GRANT_TYPE=${{ secrets.GRANT_TYPE }}
            SCOPE=${{ secrets.SCOPE }}
            ACCOUNT_NUMBER=${{ secrets.ACCOUNT_NUMBER }}

            # AWS S3
            AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_REGION=${{ secrets.AWS_REGION }}
            BUCKET_NAME=${{ secrets.BUCKET_NAME }}

            # Airtable
            AIRTABLE_TOKEN=${{ secrets.AIRTABLE_TOKEN }}
            AIRTABLE_BASE_ORDER_ID=${{ secrets.AIRTABLE_BASE_ORDER_ID }}
            AIRTABLE_BASE_ORDERTEXT_ID=${{ secrets.AIRTABLE_BASE_ORDERTEXT_ID }}
            AIRTABLE_BASE_SUPPLIERAPP_ID=${{ secrets.AIRTABLE_BASE_SUPPLIERAPP_ID }}
            AIRTABLE_BASE_REGISTER_ID=${{ secrets.AIRTABLE_BASE_REGISTER_ID }}
            AIRTABLE_TABLE_ORDERTEXT_NAME=${{ secrets.AIRTABLE_TABLE_ORDERTEXT_NAME }}
            AIRTABLE_TABLE_ORDERSUPPLIERAPP_NAME=${{ secrets.AIRTABLE_TABLE_ORDERSUPPLIERAPP_NAME }}
            AIRTABLE_TABLE_RESTSUPPLIERAPP_NAME=${{ secrets.AIRTABLE_TABLE_RESTSUPPLIERAPP_NAME }}
            AIRTABLE_TABLE_SUPPLIERSUPPLIERAPP_NAME=${{ secrets.AIRTABLE_TABLE_SUPPLIERSUPPLIERAPP_NAME }}
            AIRTABLE_TABLE_REGISTER_NAME=${{ secrets.AIRTABLE_TABLE_REGISTER_NAME }}
            AIRTABLE_TABLE_ORDER_NAME=${{ secrets.AIRTABLE_TABLE_ORDER_NAME }}
            AIRTABLE_TABLE_DETAILING_NAME=${{ secrets.AIRTABLE_TABLE_DETAILING_NAME }}
            AIRTABLE_TABLE_SUPPLIER_NAME=${{ secrets.AIRTABLE_TABLE_SUPPLIER_NAME }}
            AIRTABLE_TABLE_REST_NAME=${{ secrets.AIRTABLE_TABLE_REST_NAME }}
            AIRTABLE_TABLE_PRODUCT_NAME=${{ secrets.AIRTABLE_TABLE_PRODUCT_NAME }}
            AIRTABLE_BASE_DBCLIENTE_ID=${{ secrets.AIRTABLE_BASE_DBCLIENTE_ID }}
            AIRTABLE_TABLE_DBCLIENTE_NAME=${{ secrets.AIRTABLE_TABLE_DBCLIENTE_NAME }}
            AIRTABLE_TABLE_DB_USUARIOS_REST=${{ secrets.AIRTABLE_TABLE_DB_USUARIOS_REST }}

            # Slack
            SLACK_TOKEN=${{ secrets.SLACK_TOKEN }}
            SLACK_BUGS_AND_ERROS_CHANNELID=${{ secrets.SLACK_BUGS_AND_ERROS_CHANNELID }}

            # Outros
            MINUTES_TO_CANCEL_ORDER=${{ secrets.MINUTES_TO_CANCEL_ORDER }}
            MASTER_PASSWORD_HASH=${{ secrets.MASTER_PASSWORD_HASH }}

            # Ambiente
            NODE_ENV=production
            EOF
            echo "âœ… .env PROD criado com sucesso"
            cat .env

      - name: ðŸ³ Deploy com Docker Compose (DEV)
        if: github.ref == 'refs/heads/develop'
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/ubuntu/app-dev
            echo "ðŸ›‘ Parando container DEV antigo..."
            docker-compose -f docker-compose.dev.yml down || true
            echo "ðŸ› ï¸ Construindo e subindo API DEV..."
            docker-compose -f docker-compose.dev.yml build --no-cache
            docker-compose -f docker-compose.dev.yml up -d --force-recreate
            echo "ðŸ“‹ Logs do container DEV:"
            docker logs api-dev

      - name: ðŸ³ Deploy com Docker Compose (PROD)
        if: github.ref == 'refs/heads/main'
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/ubuntu/app-prod
            echo "ðŸ›‘ Parando container PROD antigo..."
            docker-compose -f docker-compose.prod.yml down || true
            echo "ðŸ› ï¸ Construindo e subindo API PROD..."
            docker-compose -f docker-compose.prod.yml up -d --build
            echo "ðŸ“‹ Logs do container PROD:"
            docker logs api-prod

      - name: ðŸŒ Testar conectividade com o RDS (ambos)
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "ðŸ” Testando conexÃ£o com o banco..."
            sudo apt update -y && sudo apt install -y netcat --assume-yes
            nc -zv ${{ secrets.DB_HOST }} 5432 || echo "âš ï¸ Falha na conexÃ£o com o banco"